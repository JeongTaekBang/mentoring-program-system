<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700&display=swap" rel="stylesheet">
  <?!= include('styles'); ?>
  <?!= include('common'); ?>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“Š ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
      <p>ì „ì²´ ë©˜í† ë§ í”„ë¡œê·¸ë¨ ì‹ ì²­ í˜„í™©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
    </div>
    
    <div class="content">
      <div id="adminLogin">
        <h2>ê´€ë¦¬ì ì¸ì¦</h2>
        <div class="form-group">
          <label for="adminPin">ê´€ë¦¬ì PIN *</label>
          <input type="password" id="adminPin" placeholder="ê´€ë¦¬ì PIN ì…ë ¥">
        </div>
        <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
          <button class="btn btn-primary" onclick="submitAdminPin()">ì¸ì¦</button>
          <label style="user-select:none; cursor:pointer;">
            <input type="checkbox" id="rememberPin">
            ì´ ë¸Œë¼ìš°ì €ì— 12ì‹œê°„ ì €ì¥
          </label>
        </div>
        <div id="adminLoginMsg" class="alert alert-info" style="display:none; margin-top:10px;"></div>
      </div>

      <div class="alert alert-info">
        <strong>ê´€ë¦¬ì ì „ìš© í˜ì´ì§€ì…ë‹ˆë‹¤.</strong> ì „ì²´ í”„ë¡œê·¸ë¨ ë° ì‹ ì²­ í˜„í™©ì„ í™•ì¸í•˜ê³  ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </div>
      
      <div id="adminActions" style="margin-bottom: 20px; display:none;">
        <button class="btn btn-primary" onclick="loadDashboard()">ğŸ“Š í˜„í™© ìƒˆë¡œê³ ì¹¨</button>
        <button class="btn btn-secondary" onclick="syncPrograms()">ğŸ”„ í”„ë¡œê·¸ë¨ ë™ê¸°í™”</button>
        <button class="btn btn-secondary" onclick="updateSummary()">ğŸ“‹ ìš”ì•½ì‹œíŠ¸ ì—…ë°ì´íŠ¸</button>
        <button class="btn btn-secondary" onclick="exportUnderEnrolled()">ğŸ§¾ ë¯¸ê°œì„¤ ì‹ ì²­ì ì‹œíŠ¸ ì—…ë°ì´íŠ¸</button>
        <button class="btn btn-secondary" onclick="adminLogout()">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
      </div>

      <div id="settingsPanel" class="admin-card" style="display:none;">
        <h2>ğŸ—“ ì‹ ì²­ ê¸°ê°„ ì„¤ì •</h2>
        <p class="muted">ì‹ ì²­ ì‹œì‘/ì¢…ë£Œ ì¼ì‹œë¥¼ ë³€ê²½í•˜ë©´ ì¦‰ì‹œ ì ìš©ë˜ë©°, ëª¨ë“  í˜ì´ì§€ì˜ ì ‘ê·¼ ê¶Œí•œê³¼ ì•ˆë‚´ ë¬¸êµ¬ê°€ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.</p>
        <div class="form-grid">
          <div class="form-group">
            <label for="applicationStart">ì‹ ì²­ ì‹œì‘ ì¼ì‹œ</label>
            <input type="datetime-local" id="applicationStart">
          </div>
          <div class="form-group">
            <label for="applicationEnd">ì‹ ì²­ ì¢…ë£Œ ì¼ì‹œ</label>
            <input type="datetime-local" id="applicationEnd">
          </div>
        </div>
        <div class="form-actions">
          <button class="btn btn-secondary" type="button" onclick="loadApplicationSettings(true)">â†º ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
          <button class="btn btn-primary" type="button" onclick="saveApplicationSettings()">ğŸ’¾ ì €ì¥</button>
        </div>
        <div id="settingsMessage" class="alert" style="display:none; margin-top:15px;"></div>
        <div class="muted" id="settingsSummary" style="margin-top:10px;"></div>
      </div>

      <div id="dashboard" style="display:none;">
        <div class="loading">
          <div class="spinner"></div>
          <p>ëŒ€ì‹œë³´ë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const { escapeHtml } = CommonUI;
    let adminPinCache = '';
    let collapsibleCounter = 0;

    function setActiveAdminPin(pin) {
      adminPinCache = pin || '';
    }

    function getActiveAdminPin() {
      if (adminPinCache) return adminPinCache;
      const auth = getSavedAdminAuth();
      if (auth && auth.pin) {
        adminPinCache = auth.pin;
        return adminPinCache;
      }
      return document.getElementById('adminPin').value.trim();
    }
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
    window.onload = function() {
      // êµ¬ ë²„ì „ í‚¤ ì œê±°
      try { localStorage.removeItem('adminPin'); } catch (e) {}
      // ì €ì¥ëœ ì¸ì¦ì´ ìˆê³  ìœ íš¨ê¸°ê°„ ë‚´ì¸ ê²½ìš°ì—ë§Œ ìë™ ì¸ì¦
      const auth = getSavedAdminAuth();
      if (auth) {
        document.getElementById('adminPin').value = auth.pin;
        submitAdminPin(true);
      }
    };

    function getSavedAdminAuth() {
      try {
        const raw = localStorage.getItem('adminAuth');
        if (!raw) return null;
        const obj = JSON.parse(raw);
        if (!obj || !obj.pin || !obj.exp) return null;
        if (Date.now() > obj.exp) {
          localStorage.removeItem('adminAuth');
          return null;
        }
        return obj;
      } catch (e) { return null; }
    }

    function submitAdminPin(isAuto) {
      const pin = document.getElementById('adminPin').value.trim();
      if (!pin) {
        showAdminMsg('PINì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        return;
      }
      // ê°„ë‹¨íˆ ìœ íš¨ì„± í™•ì¸ ì‹œë„ë¥¼ ìœ„í•´ ëŒ€ì‹œë³´ë“œ í˜¸ì¶œ
      google.script.run
        .withSuccessHandler(function() {
          setActiveAdminPin(pin);
          const remember = document.getElementById('rememberPin').checked;
          if (remember && !isAuto) {
            // 12ì‹œê°„ ìœ íš¨
            const exp = Date.now() + 12 * 60 * 60 * 1000;
            localStorage.setItem('adminAuth', JSON.stringify({ pin, exp }));
          } else if (!isAuto) {
            localStorage.removeItem('adminAuth');
          }
          document.getElementById('adminLogin').style.display = 'none';
          document.getElementById('adminActions').style.display = 'block';
          document.getElementById('settingsPanel').style.display = 'block';
          document.getElementById('dashboard').style.display = 'block';
          loadApplicationSettings(true);
          loadDashboard();
        })
        .withFailureHandler(function(err) {
          showAdminMsg('ì¸ì¦ ì‹¤íŒ¨: ' + err, 'danger');
        })
        .getAdminDashboardDataWithPin(pin);
    }

    function showAdminMsg(msg, type) {
      const el = document.getElementById('adminLoginMsg');
      el.className = 'alert alert-' + (type || 'info');
      el.textContent = msg;
      el.style.display = 'block';
    }
    
    // ëŒ€ì‹œë³´ë“œ ë¡œë“œ
    function loadDashboard() {
      document.getElementById('dashboard').innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
      `;
      
      const pin = getActiveAdminPin();
      google.script.run
        .withSuccessHandler(displayDashboard)
        .withFailureHandler(function(error) {
          document.getElementById('dashboard').innerHTML = 
            '<div class="alert alert-danger">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error + '</div>';
        })
        .getAdminDashboardDataWithPin(pin);
    }

    // ëŒ€ì‹œë³´ë“œ í‘œì‹œ
    function displayDashboard(data) {
      const { summary, undersubscribed, popular, allPrograms } = data;
      collapsibleCounter = 0;

      const statusSummary = {
        full: 0,
        open: 0,
        pending: 0
      };

      allPrograms.forEach(function(program) {
        if (program.applicantCount >= program.maxCapacity) {
          statusSummary.full++;
        } else if (program.applicantCount >= 3) {
          statusSummary.open++;
        } else {
          statusSummary.pending++;
        }
      });

      const avgApplicants = summary.totalPrograms > 0
        ? (summary.totalApplications / summary.totalPrograms).toFixed(1)
        : '0.0';

      let html = `
        <div class="stats-grid">
          <div class="stat-card">
            <h4>ì´ í”„ë¡œê·¸ë¨ ìˆ˜</h4>
            <div class="number">${summary.totalPrograms}</div>
          </div>
          <div class="stat-card">
            <h4>ì´ ì‹ ì²­ ê±´ìˆ˜</h4>
            <div class="number">${summary.totalApplications}</div>
          </div>
          <div class="stat-card">
            <h4>ì „ì²´ ì‹ ì²­ë¥ </h4>
            <div class="number">${summary.averageRate}%</div>
          </div>
          <div class="stat-card">
            <h4>ì´ ìˆ˜ìš© ì¸ì›</h4>
            <div class="number">${summary.totalCapacity}</div>
          </div>
          <div class="stat-card">
            <h4>í”„ë¡œê·¸ë¨ë‹¹ í‰ê·  ì‹ ì²­</h4>
            <div class="number">${avgApplicants}</div>
          </div>
          <div class="stat-card">
            <h4>ë§ˆê° í”„ë¡œê·¸ë¨</h4>
            <div class="number">${statusSummary.full}</div>
          </div>
          <div class="stat-card">
            <h4>ê°œì„¤ í”„ë¡œê·¸ë¨</h4>
            <div class="number">${statusSummary.open}</div>
          </div>
          <div class="stat-card">
            <h4>ë¯¸ê°œì„¤ í”„ë¡œê·¸ë¨</h4>
            <div class="number">${statusSummary.pending}</div>
          </div>
        </div>
      `;

      const underContent = undersubscribed.length === 0
        ? '<div class="alert alert-success">ë¯¸ê°œì„¤ ìœ„í—˜ í”„ë¡œê·¸ë¨ì´ ì—†ìŠµë‹ˆë‹¤!</div>'
        : generateProgramCards(undersubscribed, 'warning');

      html += createCollapsibleSection('ğŸ”» ë¯¸ê°œì„¤ ìœ„í—˜ (3ëª… ë¯¸ë§Œ)', underContent, { expanded: undersubscribed.length > 0 });

      const popularContent = popular.length === 0
        ? '<div class="alert alert-info">ì•„ì§ ì •ì›ì— ë„ë‹¬í•œ í”„ë¡œê·¸ë¨ì´ ì—†ìŠµë‹ˆë‹¤.</div>'
        : generateProgramCards(popular, 'success');

      html += createCollapsibleSection('ğŸ”¥ ì¸ê¸° í”„ë¡œê·¸ë¨ (ì •ì› ë„ë‹¬)', popularContent, { expanded: false });

      html += createCollapsibleSection('ğŸ“‹ ì „ì²´ í”„ë¡œê·¸ë¨ í˜„í™©', renderProgramsTable(allPrograms), { expanded: true });
      html += createCollapsibleSection('ğŸ‘¥ ë©˜í† ë³„ ì‹ ì²­ í˜„í™©', renderMentorStatsTable(allPrograms), { expanded: false });
      html += createCollapsibleSection('ğŸ—“ ì¼ìë³„ ì‹ ì²­ ì¶”ì´', renderDateStatsTable(allPrograms), { expanded: false });
      html += createCollapsibleSection('â³ ë§ˆê° ì„ë°• (ì •ì› 1ëª… ë‚¨ìŒ)', renderNearlyFullPrograms(allPrograms), { expanded: false });

      document.getElementById('dashboard').innerHTML = html;
    }

    function createCollapsibleSection(title, content, options) {
      const opts = options || {};
      const sectionId = `collapsible-${++collapsibleCounter}`;
      const expanded = opts.expanded ? 'open' : '';
      const ariaExpanded = opts.expanded ? 'true' : 'false';

      return `
        <section class="collapsible-section ${expanded}" id="${sectionId}">
          <button class="collapsible-header" type="button" onclick="toggleCollapsible('${sectionId}', this)" aria-expanded="${ariaExpanded}">
            <span class="collapsible-title">${title}</span>
            <span class="collapsible-icon">â–¼</span>
          </button>
          <div class="collapsible-content">
            ${content}
          </div>
        </section>
      `;
    }

    function toggleCollapsible(sectionId, trigger) {
      const section = document.getElementById(sectionId);
      if (!section) return;
      section.classList.toggle('open');
      if (trigger) {
        const expanded = section.classList.contains('open');
        trigger.setAttribute('aria-expanded', expanded ? 'true' : 'false');
      }
    }

    function renderProgramsTable(programs) {
      if (!programs || programs.length === 0) {
        return '<div class="alert alert-info">í‘œì‹œí•  í”„ë¡œê·¸ë¨ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
      }

      let html = `
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>í”„ë¡œê·¸ë¨ID</th>
                <th>ë©˜í† </th>
                <th>ë‚ ì§œ</th>
                <th>ì‹œê°„</th>
                <th>ì¥ì†Œ</th>
                <th>ì‹ ì²­í˜„í™©</th>
                <th>ìƒíƒœ</th>
                <th>ì‹ ì²­ì ëª…ë‹¨</th>
              </tr>
            </thead>
            <tbody>
      `;

      programs.forEach(function(program) {
        const applicantNames = program.applicants.map(function(a) { return a.name; }).join(', ') || 'ì‹ ì²­ì ì—†ìŒ';
        const shortNames = applicantNames.length > 20 ? applicantNames.substring(0, 20) + '...' : applicantNames;
        const statusClass = program.status === 'ë§ˆê°' ? 'badge-full'
          : program.status === 'ê°œì„¤' ? 'badge-open'
          : 'badge-warning';

        html += `
              <tr>
                <td>${escapeHtml(program.programId)}</td>
                <td>${escapeHtml(program.mentorName)}</td>
                <td>${escapeHtml(program.date)}</td>
                <td>${escapeHtml(program.time)}</td>
                <td>${escapeHtml(program.location)}</td>
                <td>${program.applicantCount}/${program.maxCapacity}</td>
                <td><span class="badge ${statusClass}">${escapeHtml(program.status)}</span></td>
                <td title="${escapeHtml(applicantNames)}">
                  ${escapeHtml(shortNames)}
                </td>
              </tr>
        `;
      });

      html += `
            </tbody>
          </table>
        </div>
      `;
      return html;
    }

    function renderMentorStatsTable(programs) {
      if (!programs || programs.length === 0) {
        return '<div class="alert alert-info">ë©˜í† ë³„ í†µê³„ë¥¼ ê³„ì‚°í•  í”„ë¡œê·¸ë¨ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
      }

      const mentorMap = {};
      programs.forEach(function(program) {
        const key = program.mentorName || 'ë©˜í†  ë¯¸ì •';
        if (!mentorMap[key]) {
          mentorMap[key] = {
            mentorName: key,
            programCount: 0,
            applicants: 0,
            full: 0,
            open: 0,
            pending: 0
          };
        }
        const entry = mentorMap[key];
        entry.programCount++;
        entry.applicants += program.applicantCount;
        if (program.applicantCount >= program.maxCapacity) {
          entry.full++;
        } else if (program.applicantCount >= 3) {
          entry.open++;
        } else {
          entry.pending++;
        }
      });

      const rows = Object.values(mentorMap).sort(function(a, b) {
        return b.applicants - a.applicants;
      });

      let html = `
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>ë©˜í† </th>
                <th>í”„ë¡œê·¸ë¨ ìˆ˜</th>
                <th>ì‹ ì²­ì ìˆ˜</th>
                <th>í‰ê·  ì‹ ì²­</th>
                <th>ë§ˆê°</th>
                <th>ê°œì„¤</th>
                <th>ë¯¸ê°œì„¤</th>
              </tr>
            </thead>
            <tbody>
      `;

      rows.forEach(function(row) {
        const avg = row.programCount > 0 ? (row.applicants / row.programCount).toFixed(1) : '0.0';
        html += `
              <tr>
                <td>${escapeHtml(row.mentorName)}</td>
                <td>${row.programCount}</td>
                <td>${row.applicants}</td>
                <td>${avg}</td>
                <td>${row.full}</td>
                <td>${row.open}</td>
                <td>${row.pending}</td>
              </tr>
        `;
      });

      html += `
            </tbody>
          </table>
        </div>
      `;
      return html;
    }

    function renderDateStatsTable(programs) {
      if (!programs || programs.length === 0) {
        return '<div class="alert alert-info">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      }

      const dateMap = {};
      programs.forEach(function(program) {
        const key = program.date || 'ë‚ ì§œ ë¯¸ì •';
        if (!dateMap[key]) {
          dateMap[key] = {
            date: key,
            programCount: 0,
            applicants: 0,
            capacity: 0,
            full: 0
          };
        }
        const entry = dateMap[key];
        entry.programCount++;
        entry.applicants += program.applicantCount;
        entry.capacity += program.maxCapacity;
        if (program.applicantCount >= program.maxCapacity) {
          entry.full++;
        }
      });

      const rows = Object.values(dateMap).sort(function(a, b) {
        if (a.date === b.date) return 0;
        return a.date > b.date ? 1 : -1;
      });

      let html = `
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>ë‚ ì§œ</th>
                <th>í”„ë¡œê·¸ë¨ ìˆ˜</th>
                <th>ì‹ ì²­ì ìˆ˜</th>
                <th>í‰ê·  ì‹ ì²­</th>
                <th>ì‹ ì²­ë¥ </th>
                <th>ë§ˆê° í”„ë¡œê·¸ë¨</th>
              </tr>
            </thead>
            <tbody>
      `;

      rows.forEach(function(row) {
        const avg = row.programCount > 0 ? (row.applicants / row.programCount).toFixed(1) : '0.0';
        const rate = row.capacity > 0 ? Math.round((row.applicants / row.capacity) * 100) : 0;
        html += `
              <tr>
                <td>${escapeHtml(row.date)}</td>
                <td>${row.programCount}</td>
                <td>${row.applicants}</td>
                <td>${avg}</td>
                <td>${rate}%</td>
                <td>${row.full}</td>
              </tr>
        `;
      });

      html += `
            </tbody>
          </table>
        </div>
      `;
      return html;
    }

    function renderNearlyFullPrograms(programs) {
      if (!programs || programs.length === 0) {
        return '<div class="alert alert-info">í‘œì‹œí•  í”„ë¡œê·¸ë¨ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
      }
      const targets = programs.filter(function(program) {
        return program.maxCapacity - program.applicantCount === 1;
      });
      if (targets.length === 0) {
        return '<div class="alert alert-info">ë§ˆê° ì„ë°• í”„ë¡œê·¸ë¨ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
      }
      return generateProgramCards(targets, 'success');
    }
    
    function loadApplicationSettings(isSilent) {
      const pin = getActiveAdminPin();
      if (!pin) return;

      google.script.run
        .withSuccessHandler(function(settings) {
          populateApplicationSettings(settings);
          if (isSilent) {
            const el = document.getElementById('settingsMessage');
            if (el) el.style.display = 'none';
          } else {
            showSettingsMsg('ì‹ ì²­ ê¸°ê°„ ì •ë³´ë¥¼ ìƒˆë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.', 'info');
          }
        })
        .withFailureHandler(function(error) {
          showSettingsMsg('ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: ' + error, 'danger');
        })
        .getApplicationSettingsWithPin(pin);
    }

    function populateApplicationSettings(settings) {
      if (!settings) return;
      document.getElementById('applicationStart').value = settings.startDateTime || '';
      document.getElementById('applicationEnd').value = settings.endDateTime || '';
      updateSettingsSummary(settings);
    }

    function saveApplicationSettings() {
      const start = document.getElementById('applicationStart').value;
      const end = document.getElementById('applicationEnd').value;

      if (!start || !end) {
        showSettingsMsg('ì‹œì‘ê³¼ ì¢…ë£Œ ì¼ì‹œë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        return;
      }
      if (start >= end) {
        showSettingsMsg('ì¢…ë£Œ ì¼ì‹œëŠ” ì‹œì‘ ì¼ì‹œ ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤.', 'warning');
        return;
      }

      const pin = getActiveAdminPin();
      google.script.run
        .withSuccessHandler(function(updated) {
          populateApplicationSettings(updated);
          showSettingsMsg('ì‹ ì²­ ê¸°ê°„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
          loadDashboard();
        })
        .withFailureHandler(function(error) {
          showSettingsMsg('ì €ì¥ ì‹¤íŒ¨: ' + error, 'danger');
        })
        .updateApplicationSettingsWithPin(pin, {
          startDateTime: start,
          endDateTime: end
        });
    }

    function showSettingsMsg(message, type) {
      const el = document.getElementById('settingsMessage');
      if (!el) return;
      el.className = 'alert alert-' + (type || 'info');
      el.textContent = message;
      el.style.display = 'block';
    }

    function updateSettingsSummary(settings) {
      const summary = document.getElementById('settingsSummary');
      if (!summary) return;
      if (settings && settings.startDateLabel && settings.endDateLabel) {
        summary.textContent = `í˜„ì¬ ì‹ ì²­ ê¸°ê°„: ${settings.startDateLabel} ~ ${settings.endDateLabel}`;
      } else {
        summary.textContent = '';
      }
    }

    // í”„ë¡œê·¸ë¨ ì¹´ë“œ ìƒì„±
    function generateProgramCards(programs, type) {
      let html = '<div class="program-grid">';
      
      programs.forEach(program => {
        const applicantNames = program.applicants.map(a => a.name).join(', ') || 'ì‹ ì²­ì ì—†ìŒ';
        
        const status = program.status || (program.applicantCount >= program.maxCapacity ? 'ë§ˆê°' : (program.applicantCount >= 3 ? 'ê°œì„¤' : 'ë¯¸ê°œì„¤'));
        const statusClass = status === 'ë§ˆê°' ? 'badge-full' : status === 'ê°œì„¤' ? 'badge-open' : 'badge-warning';

        html += `
          <div class="program-card">
            <h4>${escapeHtml(program.mentorName)} ë©˜í† </h4>
            <div class="program-info">
              <strong>ë‚ ì§œ:</strong> ${escapeHtml(program.date)}<br>
              <strong>ì‹œê°„:</strong> ${escapeHtml(program.time)}<br>
              <strong>ì¥ì†Œ:</strong> ${escapeHtml(program.location)}<br>
              <strong>ì‹ ì²­ì:</strong> ${program.applicantCount}/${program.maxCapacity}ëª…
              <div class="badge-row" style="margin-top:6px;">
                <span class="badge ${statusClass}">${status}</span>
              </div>
            </div>
            <div class="program-info">
              <strong>ì‹ ì²­ì ëª…ë‹¨:</strong><br>
              ${escapeHtml(applicantNames)}
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      return html;
    }
    
    // í”„ë¡œê·¸ë¨ ë™ê¸°í™”
    function syncPrograms() {
      if (!confirm('Forms ì‘ë‹µ ë°ì´í„°ë¥¼ í”„ë¡œê·¸ë¨ ëª©ë¡ìœ¼ë¡œ ë™ê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }
      
      const pin = getActiveAdminPin();
      google.script.run
        .withSuccessHandler(function(count) {
          alert(`ë™ê¸°í™” ì™„ë£Œ! ${count}ê°œì˜ í”„ë¡œê·¸ë¨ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
          loadDashboard();
        })
        .withFailureHandler(function(error) {
          alert('ë™ê¸°í™” ì‹¤íŒ¨: ' + error);
        })
        .syncFormsToProgramsWithPin(pin);
    }
    
    // ìš”ì•½ ì‹œíŠ¸ ì—…ë°ì´íŠ¸
    function updateSummary() {
      const pin = getActiveAdminPin();
      google.script.run
        .withSuccessHandler(function(message) {
          alert(message);
        })
        .withFailureHandler(function(error) {
          alert('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + error);
        })
        .updateSummarySheetWithPin(pin);
    }

    function exportUnderEnrolled() {
      const pin = getActiveAdminPin();
      google.script.run
        .withSuccessHandler(function(message) {
          alert(message);
        })
        .withFailureHandler(function(error) {
          alert('ì‹œíŠ¸ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + error);
        })
        .exportUnderEnrolledApplicantsWithPin(pin);
    }

    function adminLogout() {
      try { localStorage.removeItem('adminAuth'); } catch (e) {}
      setActiveAdminPin('');
      document.getElementById('adminLogin').style.display = 'block';
      document.getElementById('adminActions').style.display = 'none';
      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('settingsPanel').style.display = 'none';
      document.getElementById('settingsMessage').style.display = 'none';
      document.getElementById('settingsSummary').textContent = '';
      document.getElementById('adminPin').value = '';
      showAdminMsg('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
  </script>
</body>
</html>
