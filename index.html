<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700&display=swap" rel="stylesheet">
  <?!= include('styles'); ?>
  <?!= include('common'); ?>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“ ë©˜í† ë§ í”„ë¡œê·¸ë¨ ì‹ ì²­</h1>
      <p>2025ë…„ ì‹ ì…ìƒ ë©˜í† ë§ í”„ë¡œê·¸ë¨ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤</p>
    </div>
    
    <div class="content">
      <div id="periodAlert" class="alert"></div>
      
      <div id="applicationForm" style="display: none;">
        <h2>ì‹ ì²­ì ì •ë³´ ì…ë ¥</h2>
        <form id="menteeForm">
          <div class="form-group" style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <label style="font-weight: 600; margin-bottom: 10px; display: block;">ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš© ë™ì˜ *</label>
            <div style="background-color: white; padding: 12px; border: 1px solid #dee2e6; border-radius: 5px; margin-bottom: 15px; font-size: 14px; line-height: 1.5;">
              2025í•™ë…„ë„ 'ê°€ëŒ€ í›„ë°°ì‚¬ë‘ 100ì¸ ë©˜í† ë§ í”„ë¡œê·¸ë¨' ì°¸ì—¬ë¥¼ ìœ„í•´ ê°œì¸ì •ë³´(ì„±ëª…, í•™ë²ˆ, ì†Œì†, ì „í™”ë²ˆí˜¸, ì´ë©”ì¼)ë¥¼ ìˆ˜ì§‘í•˜ë©°, í”„ë¡œê·¸ë¨ ìš´ì˜ ì¢…ë£Œ ì‹œê¹Œì§€ ë³´ìœ í•©ë‹ˆë‹¤.
            </div>
            <div style="text-align: center;">
              <label style="cursor: pointer; display: inline-block; margin-right: 30px; font-weight: 500;">
                <input type="radio" name="privacyAgree" value="ì˜ˆ" required style="margin-right: 5px;">
                ë™ì˜í•©ë‹ˆë‹¤
              </label>
              <label style="cursor: pointer; display: inline-block; font-weight: 500;">
                <input type="radio" name="privacyAgree" value="ì•„ë‹ˆì˜¤" required style="margin-right: 5px;">
                ë™ì˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤
              </label>
            </div>
          </div>
          
          <div class="form-group">
            <label for="studentId">í•™ë²ˆ *</label>
            <input type="text" id="studentId" required placeholder="ì˜ˆ: 202512345">
          </div>
          
          <div class="form-group">
            <label for="name">ì´ë¦„ *</label>
            <input type="text" id="name" required placeholder="í™ê¸¸ë™">
          </div>
          
          <div class="form-group">
            <label for="department">í•™ê³¼ *</label>
            <input type="text" id="department" required placeholder="ì»´í“¨í„°ê³µí•™ê³¼">
          </div>
          
          <div class="form-group">
            <label for="email">ì´ë©”ì¼ *</label>
            <input type="email" id="email" required placeholder="example@gmail.com">
          </div>
          
          <div class="form-group">
            <label for="phone">ì „í™”ë²ˆí˜¸ *</label>
            <input type="tel" id="phone" required placeholder="01012345678" maxlength="11" pattern="[0-9]{10,11}">
            <small style="color: #666; font-size: 12px;">í•˜ì´í”ˆ(-) ì—†ì´ ìˆ«ìë§Œ ì…ë ¥í•´ì£¼ì„¸ìš”</small>
          </div>
          
          <button type="submit" class="btn btn-primary">í”„ë¡œê·¸ë¨ ëª©ë¡ ë³´ê¸°</button>
        </form>
      </div>
      
      <div id="programList" style="display: none;">
        <h2>í”„ë¡œê·¸ë¨ ì„ íƒ</h2>
        <div class="alert alert-info">
          ìµœì†Œ 1ê°œ, ìµœëŒ€ 3ê°œê¹Œì§€ ì‹ ì²­ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì‹œê°„ì´ ê²¹ì¹˜ëŠ” í”„ë¡œê·¸ë¨ì€ ì‹ ì²­í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
        </div>
        
        <div id="filterSection">
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px;">
            <input type="text" id="searchInput" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥ (ì˜ˆ: í™ê¸¸ë™, 12ì›”, 25ì¼, ì˜¤ì „, ì˜¤í›„, ê°•ì˜ì‹¤)..." 
                  style="flex:1; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
            <select id="statusFilter" style="padding:10px; border:2px solid #e0e0e0; border-radius:8px;">
              <option value="all">ì „ì²´</option>
              <option value="open">ì‹ ì²­ê°€ëŠ¥</option>
              <option value="full">ë§ˆê°</option>
              <option value="launch">ê°œì„¤(3ëª… ì´ìƒ)</option>
              <option value="draft">ë¯¸ê°œì„¤(0~2ëª…)</option>
            </select>
            <select id="groupBy" style="padding:10px; border:2px solid #e0e0e0; border-radius:8px;">
              <option value="none">ê·¸ë£¹ ì—†ìŒ</option>
              <option value="date" selected>ë‚ ì§œë³„ ê·¸ë£¹</option>
              <option value="mentor">ë©˜í† ë³„ ê·¸ë£¹</option>
            </select>
            <select id="sortBy" style="padding:10px; border:2px solid #e0e0e0; border-radius:8px;">
              <option value="time">ì‹œê°„ìˆœ</option>
              <option value="seats">ì”ì—¬ì¢Œì„ ë§ì€ìˆœ</option>
            </select>
            <button type="button" id="expandAll" class="btn btn-secondary">ëª¨ë‘ í¼ì¹˜ê¸°</button>
            <button type="button" id="collapseAll" class="btn btn-secondary">ëª¨ë‘ ì ‘ê¸°</button>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
            <button type="button" class="btn btn-secondary" data-qf="all">ì „ì²´</button>
            <button type="button" class="btn btn-secondary" data-qf="today">ì˜¤ëŠ˜ ì´í›„</button>
            <button type="button" class="btn btn-secondary" data-qf="week">ì´ë²ˆ ì£¼</button>
            <button type="button" class="btn btn-secondary" data-qf="closing">ë§ˆê° ì„ë°•</button>
          </div>
          <div style="font-size: 12px; color: #666; margin-bottom: 5px;">
            ğŸ’¡ ê²€ìƒ‰ ê°€ëŠ¥: ë©˜í†  ì´ë¦„, í”„ë¡œê·¸ë¨ ë‚´ìš©, ì¥ì†Œ, ë‚ ì§œ(2024-12-25, 12-25, 12ì›”, 25ì¼), ì‹œê°„(14:00, ì˜¤ì „, ì˜¤í›„)
          </div>
        </div>
        
        <div id="programs" class="program-grid">
          <div class="loading">
            <div class="spinner"></div>
            <p>í”„ë¡œê·¸ë¨ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
          </div>
        </div>
        
        <!-- ìƒì„¸ ëª¨ë‹¬ -->
        <div id="detailOverlay" class="modal-overlay" onclick="closeProgramDetail(event)">
          <div class="modal" role="dialog" aria-modal="true" aria-labelledby="detailTitle" onclick="event.stopPropagation()">
            <div class="modal-header">
              <h3 id="detailTitle" style="margin:0; font-size:1.2em;">í”„ë¡œê·¸ë¨ ìƒì„¸</h3>
              <button class="modal-close" onclick="closeProgramDetail(event)">âœ•</button>
            </div>
            <div id="detailBody"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let menteeInfo = {};
    let programs = [];
    let isApplicationOpen = true; // ì‹ ì²­ ê°€ëŠ¥ ì—¬ë¶€ ì „ì—­ ë³€ìˆ˜
    let searchDebounceTimer;
    let quickFilter = 'all';
    const { escapeHtml, resolvePeriodStatus, PERIOD_STATUS } = CommonUI;
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
    window.onload = function() {
      checkPeriod();
    };
    
    // ì‹ ì²­ ê¸°ê°„ í™•ì¸
    function checkPeriod() {
      google.script.run
        .withSuccessHandler(function(result) {
          const alertDiv = document.getElementById('periodAlert');
          isApplicationOpen = result.isOpen; // ì „ì—­ ë³€ìˆ˜ ì„¤ì •
          
          const status = resolvePeriodStatus(result);
          let icon = 'âœ…';
          let alertClass = 'alert alert-success';

          if (status === PERIOD_STATUS.CLOSED) {
            icon = 'âŒ';
            alertClass = 'alert alert-danger';
          } else if (status === PERIOD_STATUS.SCHEDULED) {
            icon = 'â³';
            alertClass = 'alert alert-warning';
          }

          const periodText = result.startDateLabel && result.endDateLabel ?
            `<div class="muted">ì‹ ì²­ ê¸°ê°„: ${escapeHtml(result.startDateLabel)} ~ ${escapeHtml(result.endDateLabel)}</div>` : '';

          alertDiv.className = alertClass;
          alertDiv.innerHTML = `${icon} ${escapeHtml(result.message)}${periodText}`;

          // ì‹ ì²­ í¼ì€ í•­ìƒ ë…¸ì¶œ (ë‹¨, ì‹ ì²­ ë²„íŠ¼ì€ isApplicationOpenìœ¼ë¡œ ì œì–´)
          document.getElementById('applicationForm').style.display = 'block';
        })
        .withFailureHandler(function(error) {
          console.error('Error:', error);
          // ì—ëŸ¬ê°€ ë°œìƒí•´ë„ í¼ì€ í‘œì‹œ
          document.getElementById('applicationForm').style.display = 'block';
        })
        .checkApplicationPeriod();
    }
    
    // ë‚ ì§œ ê²€ìƒ‰ ë§¤ì¹­ í•¨ìˆ˜
    function searchDateMatch(programDate, searchTerm) {
      // programDate í˜•ì‹: "YYYY-MM-DD"
      if (!programDate || !searchTerm) return false;
      
      // ì „ì²´ ë‚ ì§œ ê²€ìƒ‰ (2024-12-25)
      if (programDate.toLowerCase().includes(searchTerm)) return true;
      
      // ë‚ ì§œë¥¼ íŒŒì‹±
      const [year, month, day] = programDate.split('-');
      
      // ì›”-ì¼ ê²€ìƒ‰ (12-25)
      const monthDay = `${month}-${day}`;
      if (monthDay.includes(searchTerm)) return true;
      
      // ì›”/ì¼ ê²€ìƒ‰ (12/25)
      const monthDaySlash = `${month}/${day}`;
      if (monthDaySlash.includes(searchTerm)) return true;
      
      // ì›” ì´ë¦„ ê²€ìƒ‰ (í•œê¸€)
      const monthNames = ['', '1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', 
                          '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];
      const monthNum = parseInt(month);
      if (monthNames[monthNum] && monthNames[monthNum].includes(searchTerm)) return true;
      
      // ì›”ë§Œ ê²€ìƒ‰ (ìˆ«ì)
      if (searchTerm.length <= 2 && month.includes(searchTerm.padStart(2, '0'))) return true;
      
      // ì¼ë§Œ ê²€ìƒ‰ (ìˆ«ì)
      if (searchTerm.endsWith('ì¼')) {
        const daySearch = searchTerm.replace('ì¼', '').padStart(2, '0');
        if (day === daySearch) return true;
      }
      
      // ë…„ë„ ê²€ìƒ‰
      if (year.includes(searchTerm)) return true;
      
      return false;
    }
    
    // í¼ ì œì¶œ
    document.getElementById('menteeForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      // ê°œì¸ì •ë³´ ë™ì˜ ì²´í¬
      const privacyAgree = document.querySelector('input[name="privacyAgree"]:checked');
      if (!privacyAgree) {
        alert('ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš©ì— ë™ì˜í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      if (privacyAgree.value === 'ì•„ë‹ˆì˜¤') {
        alert('ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš©ì— ë™ì˜í•˜ì§€ ì•Šìœ¼ë©´ í”„ë¡œê·¸ë¨ì— ì°¸ì—¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      menteeInfo = {
        studentId: document.getElementById('studentId').value,
        name: document.getElementById('name').value,
        department: document.getElementById('department').value,
        email: document.getElementById('email').value,
        phone: document.getElementById('phone').value,
        privacyAgree: privacyAgree.value
      };
      
      // ì „í™”ë²ˆí˜¸ í˜•ì‹ ê²€ì¦ (í•˜ì´í”ˆ ì—†ì´ 10-11ìë¦¬ ìˆ«ì)
      const phoneRegex = /^01[0-9]{8,9}$/;
      if (!phoneRegex.test(menteeInfo.phone)) {
        alert('ì „í™”ë²ˆí˜¸ëŠ” í•˜ì´í”ˆ(-) ì—†ì´ ìˆ«ìë§Œ ì…ë ¥í•´ì£¼ì„¸ìš”.\nì˜ˆ: 01074903697');
        return;
      }
      
      document.getElementById('applicationForm').style.display = 'none';
      document.getElementById('programList').style.display = 'block';
      loadPrograms();
    });
    
    // í”„ë¡œê·¸ë¨ ëª©ë¡ ë¡œë“œ
    function loadPrograms() {
      google.script.run
        .withSuccessHandler(displayPrograms)
        .withFailureHandler(function(error) {
          console.error('Error:', error);
          document.getElementById('programs').innerHTML = 
            '<div class="alert alert-danger">í”„ë¡œê·¸ë¨ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
        })
        .getPrograms();
    }
    
    // í”„ë¡œê·¸ë¨ í‘œì‹œ
    function displayPrograms(data) {
      programs = data;
      renderPrograms();
    }
    
    // í”„ë¡œê·¸ë¨ ë Œë”ë§
    function renderPrograms() {
      const searchTerm = document.getElementById('searchInput') ? 
                        document.getElementById('searchInput').value.toLowerCase().trim() : '';
      const status = document.getElementById('statusFilter') ? document.getElementById('statusFilter').value : 'all';
      const groupBy = document.getElementById('groupBy') ? document.getElementById('groupBy').value : 'none';
      const sortBy = document.getElementById('sortBy') ? document.getElementById('sortBy').value : 'time';
      
      // í•„í„°ë§
      let filteredPrograms = programs.filter(program => {
        // ê²€ìƒ‰ì–´ê°€ ë¹„ì–´ìˆìœ¼ë©´ ëª¨ë“  í”„ë¡œê·¸ë¨ í‘œì‹œ
        // ìƒíƒœ í•„í„° íŒì •
        const currentCount = parseInt(program.currentCount) || 0;
        const maxCount = parseInt(program.maxCount) || 7;
        const isFull = currentCount >= maxCount;
        const isLaunch = currentCount >= 3 && currentCount < maxCount;
        const isDraft = currentCount < 3;

        if (status === 'open' && isFull) return false;
        if (status === 'full' && !isFull) return false;
        if (status === 'launch' && !isLaunch) return false;
        if (status === 'draft' && !isDraft) return false;

        // í€µ í•„í„°
        if (quickFilter !== 'all') {
          // ë‚ ì§œ íŒŒì‹± (YYYY-MM-DD)
          let d = new Date(program.date);
          if (isNaN(d.getTime())) {
            const parts = String(program.date || '').split('-');
            if (parts.length === 3) {
              d = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
            }
          }
          const today = new Date(); today.setHours(0,0,0,0);
          const dow = today.getDay(); // 0=Sun
          const weekStart = new Date(today); weekStart.setDate(today.getDate() - dow + 1); // Mon
          const weekEnd = new Date(weekStart); weekEnd.setDate(weekStart.getDate() + 6); // Sun
          if (quickFilter === 'today' && !(d >= today)) return false;
          if (quickFilter === 'week' && !(d >= weekStart && d <= weekEnd)) return false;
          if (quickFilter === 'closing') {
            const remain = (maxCount - currentCount);
            if (!(remain > 0 && remain <= 2)) return false;
          }
        }

        if (!searchTerm) return true;
        
        // ê¸°ë³¸ ê²€ìƒ‰ (ë©˜í†  ì´ë¦„, ë‚´ìš©, ì¥ì†Œ)
        const basicMatch = (program.mentorName || '').toLowerCase().includes(searchTerm) ||
                          (program.content || '').toLowerCase().includes(searchTerm) ||
                          (program.location || '').toLowerCase().includes(searchTerm);
        
        // ë‚ ì§œ ê²€ìƒ‰ ê°œì„ 
        const dateMatch = searchDateMatch(program.date, searchTerm);
        
        // ì‹œê°„ ê²€ìƒ‰ ì¶”ê°€
        const timeMatch = (program.startTime && program.startTime.toLowerCase().includes(searchTerm)) ||
                         (program.endTime && program.endTime.toLowerCase().includes(searchTerm)) ||
                         (searchTerm === 'ì˜¤ì „' && parseInt(program.startTime) < 12) ||
                         (searchTerm === 'ì˜¤í›„' && parseInt(program.startTime) >= 12);
        
        return basicMatch || dateMatch || timeMatch;
      });

      // ì •ë ¬
      filteredPrograms.sort((a, b) => {
        if (sortBy === 'seats') {
          const aRemain = (parseInt(a.maxCount) || 7) - (parseInt(a.currentCount) || 0);
          const bRemain = (parseInt(b.maxCount) || 7) - (parseInt(b.currentCount) || 0);
          if (bRemain !== aRemain) return bRemain - aRemain;
        }
        // ê¸°ë³¸ ì‹œê°„ìˆœ: ë‚ ì§œ -> ì‹œì‘ì‹œê°„
        const da = new Date(a.date);
        const db = new Date(b.date);
        const dcmp = da - db;
        if (!isNaN(dcmp) && dcmp !== 0) return dcmp;
        return String(a.startTime).localeCompare(String(b.startTime));
      });
      
      // ì¹´ë“œ ìƒì„± í•¨ìˆ˜ (ë‚´ìš© 4ì¤„ ê³ ì • + ë”ë³´ê¸°ëŠ” ëª¨ë‹¬)
      function cardHTML(program) {
        // ì•ˆì „í•œ ìˆ«ì ì²˜ë¦¬
        const currentCount = parseInt(program.currentCount) || 0;
        const maxCount = parseInt(program.maxCount) || 7;
        
        const isFull = currentCount >= maxCount;
        const programStatus = program.programStatus || (isFull ? 'ë§ˆê°' : (currentCount >= 3 ? 'ê°œì„¤' : 'ë¯¸ê°œì„¤'));
        const remaining = Math.max(maxCount - currentCount, 0);

        const statusBadgeClass = programStatus === 'ë§ˆê°' ? 'badge-full' :
          (programStatus === 'ê°œì„¤' ? 'badge-open' : 'badge-warning');
        const statusBadge = `<span class="badge ${statusBadgeClass}">${programStatus}</span>`;

        const capacityBadge = isFull ?
          '<span class="badge badge-full">ì •ì› ë§ˆê°</span>' :
          `<span class="badge badge-available">ì”ì—¬ ${remaining}ëª…</span>`;
        
        return `
          <div class="program-card">
            <div class="card-body">
              <h3>${escapeHtml(program.mentorName)} ë©˜í† </h3>
              <div class="program-info"><strong>ğŸ“… ë‚ ì§œ:</strong> ${escapeHtml(program.date)}</div>
              <div class="program-info"><strong>â° ì‹œê°„:</strong> ${escapeHtml(program.startTime)} - ${escapeHtml(program.endTime)}</div>
              <div class="program-info"><strong>ğŸ“ ì¥ì†Œ:</strong> ${escapeHtml(program.location)}</div>
              <div class="program-info">
                <strong>ğŸ“ ë‚´ìš©:</strong><br>
                <div class="program-content clamp-4">${escapeHtml(program.content)}</div>
                <button type="button" class="link-button" onclick="showProgramDetail('${program.programId}')">ë”ë³´ê¸°</button>
              </div>
              <div class="program-info">
                <strong>ğŸ‘¥ ì‹ ì²­í˜„í™©:</strong> ${currentCount}/${maxCount}ëª…
                <div class="badge-row">
                  ${statusBadge}
                  ${capacityBadge}
                </div>
              </div>
            </div>
            <div class="card-footer">
              <button class="btn btn-primary" 
                      onclick="applyProgram('${program.programId}')"
                      ${isFull || !isApplicationOpen ? 'disabled' : ''}>
                ${!isApplicationOpen ? 'ë§ˆê°' : 'ì‹ ì²­í•˜ê¸°'}
              </button>
            </div>
          </div>
        `;
      }

      let html = '';
      if (groupBy === 'none') {
        filteredPrograms.forEach(program => { html += cardHTML(program); });
      } else {
        const groupKey = groupBy === 'date' ? (p) => p.date : (p) => p.mentorName;
        const groups = {};
        filteredPrograms.forEach(p => {
          const key = groupKey(p) || 'ê¸°íƒ€';
          if (!groups[key]) groups[key] = [];
          groups[key].push(p);
        });
        const keys = Object.keys(groups).sort();
        keys.forEach(key => {
          const list = groups[key];
          // ê·¸ë£¹ ìš”ì•½ ì •ë³´
          const total = list.length;
          const applicants = list.reduce((sum, p) => sum + (parseInt(p.currentCount) || 0), 0);
          const capacity = list.reduce((sum, p) => sum + (parseInt(p.maxCount) || 7), 0);
          html += `
            <details class="group" open>
              <summary style="cursor:pointer; font-weight:600; padding:8px 4px;">${escapeHtml(key)} â€” ${total}ê°œ, ${applicants}/${capacity}ëª…</summary>
              <div class="program-grid">
                ${list.map(cardHTML).join('')}
              </div>
            </details>
          `;
        });
      }
      
      if (filteredPrograms.length === 0) {
        html = '<div class="alert alert-warning">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      }
      
      document.getElementById('programs').innerHTML = html;

      // ë¹„êµ íŒ¨ë„ ì œê±°ë¨
    }
    
    // ê²€ìƒ‰ ì´ë²¤íŠ¸
    document.addEventListener('input', function(e) {
      if (e.target.id === 'searchInput') {
        if (searchDebounceTimer) clearTimeout(searchDebounceTimer);
        searchDebounceTimer = setTimeout(renderPrograms, 200);
      }
    });
    document.addEventListener('change', function(e) {
      if (e.target.id === 'statusFilter') {
        renderPrograms();
      }
      if (e.target.id === 'groupBy' || e.target.id === 'sortBy') {
        renderPrograms();
      }
    });

    // í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬ (ê·¸ë£¹ ì ‘ê¸°/í¼ì¹˜ê¸°, í€µí•„í„°)
    document.addEventListener('click', function(e) {
      if (e.target && e.target.id === 'expandAll') {
        document.querySelectorAll('details.group').forEach(d => d.setAttribute('open', ''));
      }
      if (e.target && e.target.id === 'collapseAll') {
        document.querySelectorAll('details.group').forEach(d => d.removeAttribute('open'));
      }
      if (e.target && e.target.dataset && e.target.dataset.qf) {
        quickFilter = e.target.dataset.qf;
        renderPrograms();
      }
    });

    // ìƒì„¸ ëª¨ë‹¬ ì—´ê¸°
    function showProgramDetail(programId) {
      const p = programs.find(pr => pr.programId === programId);
      if (!p) return;
      const currentCount = parseInt(p.currentCount, 10) || 0;
      const maxCount = parseInt(p.maxCount, 10) || 7;
      const statusLabel = p.programStatus || (currentCount >= maxCount ? 'ë§ˆê°' : (currentCount >= 3 ? 'ê°œì„¤' : 'ë¯¸ê°œì„¤'));
      const statusClass = statusLabel === 'ë§ˆê°' ? 'badge-full' : statusLabel === 'ê°œì„¤' ? 'badge-open' : 'badge-warning';
      const body = document.getElementById('detailBody');
      body.innerHTML = `
        <div class="program-info"><strong>ë©˜í† :</strong> ${escapeHtml(p.mentorName)}</div>
        <div class="program-info"><strong>ë‚ ì§œ:</strong> ${escapeHtml(p.date)}</div>
        <div class="program-info"><strong>ì‹œê°„:</strong> ${escapeHtml(p.startTime)} - ${escapeHtml(p.endTime)}</div>
        <div class="program-info"><strong>ì¥ì†Œ:</strong> ${escapeHtml(p.location)}</div>
        <div class="program-info"><strong>ë‚´ìš©:</strong><br><div class="program-content">${escapeHtml(p.content)}</div></div>
        <div class="program-info">
          <strong>ì‹ ì²­í˜„í™©:</strong> ${currentCount}/${maxCount}ëª…
          <div class="badge-row">
            <span class="badge ${statusClass}">${statusLabel}</span>
            ${currentCount >= maxCount ? '<span class="badge badge-full">ì •ì› ë§ˆê°</span>' : `<span class="badge badge-available">ì”ì—¬ ${maxCount - currentCount}ëª…</span>`}
          </div>
        </div>
      `;
      document.getElementById('detailTitle').textContent = `${p.mentorName} ë©˜í†  í”„ë¡œê·¸ë¨ ìƒì„¸`;
      const overlay = document.getElementById('detailOverlay');
      overlay.style.display = 'flex';
    }

    // ìƒì„¸ ëª¨ë‹¬ ë‹«ê¸°
    function closeProgramDetail(event) {
      const overlay = document.getElementById('detailOverlay');
      overlay.style.display = 'none';
    }
    
    // í”„ë¡œê·¸ë¨ ì‹ ì²­
    function applyProgram(programId) {
      if (!isApplicationOpen) {
        alert('ì‹ ì²­ ê¸°ê°„ì´ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.');
        return;
      }
      
      if (!menteeInfo.studentId) {
        alert('ë¨¼ì € ì‹ ì²­ì ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        document.getElementById('applicationForm').style.display = 'block';
        document.getElementById('programList').style.display = 'none';
        return;
      }
      
      const program = programs.find(p => p.programId === programId);
      if (!confirm(`${program.mentorName} ë©˜í† ì˜ í”„ë¡œê·¸ë¨ì„ ì‹ ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në‚ ì§œ: ${program.date}\nì‹œê°„: ${program.startTime}-${program.endTime}`)) {
        return;
      }
      
      const applicationData = {
        ...menteeInfo,
        programId: programId
      };
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            alert(result.message);
            loadPrograms(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          } else {
            alert('ì‹ ì²­ ì‹¤íŒ¨: ' + result.message);
          }
        })
        .withFailureHandler(function(error) {
          alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error);
        })
        .submitApplication(applicationData);
    }
  </script>
</body>
</html>
