<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700&display=swap" rel="stylesheet">
  <?!= include('styles'); ?>
  <?!= include('common'); ?>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“‹ ë‚´ ì‹ ì²­í˜„í™©</h1>
      <p>ì‹ ì²­í•œ í”„ë¡œê·¸ë¨ì„ í™•ì¸í•˜ê³  ì·¨ì†Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
    </div>
    
    <div class="content">
      <div id="periodAlert" class="alert"></div>
      
      <div id="loginForm">
        <h2>ì‹ ì²­ ë‚´ì—­ ì¡°íšŒ</h2>
        <form id="checkForm">
          <div class="form-group">
            <label for="studentId">í•™ë²ˆ *</label>
            <input type="text" id="studentId" required placeholder="ì˜ˆ: 202512345">
          </div>
          
          <button type="submit" class="btn btn-primary">ì¡°íšŒí•˜ê¸°</button>
        </form>
      </div>
      
      <div id="applicationList" style="display: none;">
        <h2>ë‚˜ì˜ ì‹ ì²­ ë‚´ì—­</h2>
        <div id="cancelInfo" class="alert alert-info"></div>
        
        <div id="applications">
          <div class="loading">
            <div class="spinner"></div>
            <p>ì‹ ì²­ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
          </div>
        </div>
        
        <button class="btn btn-secondary" onclick="backToSearch()">ë‹¤ì‹œ ì¡°íšŒ</button>
      </div>
    </div>
  </div>

  <script>
    const { escapeHtml, PERIOD_STATUS, resolvePeriodStatus } = CommonUI;
    let currentStudentId = '';
    let canCancel = false;

    function getStatusLabel(app) {
      const current = parseInt(app && app.currentCount, 10) || 0;
      const max = parseInt(app && app.maxCount, 10) || 7;
      if (current >= max) return 'ë§ˆê°';
      if (app && app.programStatus) return String(app.programStatus);
      return current >= 3 ? 'ê°œì„¤' : 'ë¯¸ê°œì„¤';
    }

    function getStatusBadgeClass(app) {
      const label = getStatusLabel(app);
      if (label === 'ë§ˆê°') return 'badge-full';
      if (label === 'ê°œì„¤') return 'badge-open';
      return 'badge-warning';
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
    window.onload = function() {
      checkPeriod();
    };
    
    // ì‹ ì²­ ê¸°ê°„ í™•ì¸
    function checkPeriod() {
      google.script.run
        .withSuccessHandler(function(result) {
          const alertDiv = document.getElementById('periodAlert');
          canCancel = result.isOpen;
          
          const status = resolvePeriodStatus(result);
          let icon = 'âœ…';
          let alertClass = 'alert alert-success';

          if (status === PERIOD_STATUS.CLOSED) {
            icon = 'âš ï¸';
            alertClass = 'alert alert-warning';
            canCancel = false;
          } else if (status === PERIOD_STATUS.SCHEDULED) {
            icon = 'â³';
            alertClass = 'alert alert-info';
            canCancel = false;
          }

          const periodText = result.startDateLabel && result.endDateLabel ?
            `<div class="muted">ì‹ ì²­ ê¸°ê°„: ${escapeHtml(result.startDateLabel)} ~ ${escapeHtml(result.endDateLabel)}</div>` : '';

          alertDiv.className = alertClass;
          alertDiv.innerHTML = `${icon} ${escapeHtml(result.message)}${periodText}`;

          const cancelInfoDiv = document.getElementById('cancelInfo');
          if (cancelInfoDiv) {
            if (status === PERIOD_STATUS.OPEN) {
              cancelInfoDiv.textContent = result.endDateLabel ?
                `ì‹ ì²­ ì·¨ì†ŒëŠ” ${result.endDateLabel}ê¹Œì§€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.` :
                'í˜„ì¬ ì·¨ì†Œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.';
            } else if (status === PERIOD_STATUS.SCHEDULED) {
              cancelInfoDiv.textContent = 'ì·¨ì†ŒëŠ” ì‹ ì²­ ê¸°ê°„ ì‹œì‘ ì´í›„ ê°€ëŠ¥í•©ë‹ˆë‹¤.';
            } else {
              cancelInfoDiv.textContent = 'í˜„ì¬ëŠ” ì·¨ì†Œ ê¸°ê°„ì´ ì•„ë‹™ë‹ˆë‹¤.';
            }
          }
        })
        .withFailureHandler(function(error) {
          console.error('Error:', error);
        })
        .checkApplicationPeriod();
    }
    
    // í¼ ì œì¶œ
    document.getElementById('checkForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      currentStudentId = document.getElementById('studentId').value;
      loadApplications(currentStudentId);
    });
    
    // ì‹ ì²­ ë‚´ì—­ ë¡œë“œ
    function loadApplications(studentId) {
      google.script.run
        .withSuccessHandler(function(data) {
          if (data && data.length > 0) {
            displayApplications(data);
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('applicationList').style.display = 'block';
          } else {
            document.getElementById('applications').innerHTML = 
              '<div class="alert alert-warning">ì‹ ì²­í•œ í”„ë¡œê·¸ë¨ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('applicationList').style.display = 'block';
          }
          checkPeriod();
        })
        .withFailureHandler(function(error) {
          alert('ì¡°íšŒ ì‹¤íŒ¨: ' + error);
        })
        .getMyApplications(studentId);
    }
    
    // ì‹ ì²­ ë‚´ì—­ í‘œì‹œ
    function displayApplications(applications) {
      try {
        if (!applications || applications.length === 0) {
          document.getElementById('applications').innerHTML = 
            '<div class="alert alert-warning">ì‹ ì²­í•œ í”„ë¡œê·¸ë¨ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }
        
        let html = '<div class="table-wrapper"><table>';
      html += `
        <thead>
          <tr>
            <th>ì‹ ì²­ì¼ì‹œ</th>
            <th>ë©˜í† </th>
            <th>ë‚ ì§œ</th>
            <th>ì‹œê°„</th>
            <th>ì¥ì†Œ</th>
            <th>ë‚´ìš©</th>
            <th>ì‹ ì²­í˜„í™©</th>
            <th>ìƒíƒœ</th>
            <th>ì‘ì—…</th>
          </tr>
        </thead>
        <tbody>
      `;
      
      applications.forEach(app => {
        // timestampëŠ” ì„œë²„ì—ì„œ ì´ë¯¸ í•œêµ­ì–´ í˜•ì‹ ë¬¸ìì—´ë¡œ ì „ë‹¬ë¨
        const timestamp = app.timestamp || 'ì‹œê°„ ì •ë³´ ì—†ìŒ';
        
        html += `
          <tr>
            <td>${escapeHtml(timestamp)}</td>
            <td>${escapeHtml(app.mentorName)}</td>
            <td>${escapeHtml(app.date)}</td>
            <td>${escapeHtml(app.startTime)}-${escapeHtml(app.endTime)}</td>
            <td>${escapeHtml(app.location)}</td>
            <td>${escapeHtml(app.content)}</td>
            <td>${escapeHtml(String(app.currentCount || 0))}/${escapeHtml(String(app.maxCount || 7))}ëª…</td>
            <td><span class="badge ${getStatusBadgeClass(app)}">${escapeHtml(getStatusLabel(app))}</span></td>
            <td>
              ${canCancel ? 
                `<button class="btn btn-danger" onclick="cancelApplication('${app.applicationId}')">ì·¨ì†Œ</button>` :
                '<span class="badge badge-warning">ì·¨ì†Œë¶ˆê°€</span>'
              }
            </td>
          </tr>
        `;
      });
      
      html += '</tbody></table></div>';
      
      html += `
        <div class="alert alert-info" style="margin-top: 20px;">
          ì´ ${applications.length}ê°œ í”„ë¡œê·¸ë¨ ì‹ ì²­ ì¤‘ (ìµœëŒ€ 3ê°œ)
        </div>
      `;
      
      document.getElementById('applications').innerHTML = html;
      } catch (error) {
        document.getElementById('applications').innerHTML = 
          '<div class="alert alert-danger">ë°ì´í„°ë¥¼ í‘œì‹œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
      }
    }
    
    // ì‹ ì²­ ì·¨ì†Œ
    function cancelApplication(applicationId) {
      if (!confirm('ì •ë§ë¡œ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì·¨ì†Œ í›„ ë‹¤ì‹œ ì‹ ì²­í•˜ë ¤ë©´ ì •ì›ì´ ë‚¨ì•„ìˆì–´ì•¼ í•©ë‹ˆë‹¤.')) {
        return;
      }
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            alert(result.message);
            loadApplications(currentStudentId);
          } else {
            alert('ì·¨ì†Œ ì‹¤íŒ¨: ' + result.message);
          }
        })
        .withFailureHandler(function(error) {
          alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error);
        })
        .cancelApplication(applicationId, currentStudentId);
    }
    
    // ë‹¤ì‹œ ì¡°íšŒ
    function backToSearch() {
      document.getElementById('loginForm').style.display = 'block';
      document.getElementById('applicationList').style.display = 'none';
      document.getElementById('studentId').value = '';
    }
  </script>
</body>
</html>
