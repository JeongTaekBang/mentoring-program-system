<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700&display=swap" rel="stylesheet">
  <?!= include('styles'); ?>
  <?!= include('common'); ?>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ‘¨â€ğŸ« ë©˜í†  ì‹ ì²­ì ì¡°íšŒ</h1>
      <p>ë‚´ í”„ë¡œê·¸ë¨ì— ì‹ ì²­í•œ ë©˜í‹°ë“¤ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
    </div>
    
    <div class="content">
      <div id="loginForm">
        <h2>ë©˜í†  ì¸ì¦</h2>
        <form id="mentorForm">
          <div class="form-group">
            <label for="mentorId">í•™ë²ˆ *</label>
            <input type="text" id="mentorId" required 
                   placeholder="ë©˜í†  í•™ë²ˆ ì…ë ¥">
          </div>
          
          <button type="submit" class="btn btn-primary">ì¡°íšŒí•˜ê¸°</button>
        </form>
      </div>
      
      <div id="mentorDashboard" style="display: none;">
        <h2>ë‚´ í”„ë¡œê·¸ë¨ ì‹ ì²­ í˜„í™©</h2>
        
        <div id="programs">
          <div class="loading">
            <div class="spinner"></div>
            <p>ì‹ ì²­ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
          </div>
        </div>
        
        <button class="btn btn-secondary" onclick="backToSearch()">ë‹¤ì‹œ ì¡°íšŒ</button>
      </div>
    </div>
  </div>

  <script>
    const { escapeHtml } = CommonUI;
    function safeTel(t) {
      return String(t || '').replace(/[^0-9+]/g, '');
    }
    function safeMailto(m) {
      return encodeURIComponent(String(m || ''));
    }
    // í¼ ì œì¶œ
    document.getElementById('mentorForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const mentorId = document.getElementById('mentorId').value.trim();
      console.log('ë©˜í†  í•™ë²ˆ:', mentorId); // ë””ë²„ê¹…ìš©
      
      if (!mentorId) {
        alert('í•™ë²ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      // ë¡œë”© í‘œì‹œ
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('mentorDashboard').style.display = 'block';
      
      loadMentorApplications(mentorId);
    });
    
    // ë©˜í†  ì‹ ì²­ì ëª©ë¡ ë¡œë“œ
    function loadMentorApplications(mentorId) {
      console.log('loadMentorApplications í˜¸ì¶œ:', mentorId); // ë””ë²„ê¹…ìš©
      
      google.script.run
        .withSuccessHandler(function(data) {
          console.log('ì„±ê³µ ì‘ë‹µ:', data); // ë””ë²„ê¹…ìš©
          displayMentorApplications(data);
        })
        .withFailureHandler(function(error) {
          console.error('ì‹¤íŒ¨ ì‘ë‹µ:', error); // ë””ë²„ê¹…ìš©
          
          // ì—ëŸ¬ ì‹œ ë¡œê·¸ì¸ í¼ìœ¼ë¡œ ëŒì•„ê°€ê¸°
          document.getElementById('loginForm').style.display = 'block';
          document.getElementById('mentorDashboard').style.display = 'none';
          
          alert('ì¡°íšŒ ì‹¤íŒ¨: ' + error + '\\n\\në“±ë¡ëœ í•™ë²ˆì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
        })
        .getMentorApplications(mentorId);
    }
    
    // ë©˜í†  ì‹ ì²­ì ëª©ë¡ í‘œì‹œ
    function displayMentorApplications(programs) {
      console.log('displayMentorApplications í˜¸ì¶œ:', programs); // ë””ë²„ê¹…ìš©
      
      if (!programs || programs.length === 0) {
        document.getElementById('programs').innerHTML = 
          '<div class="alert alert-warning">ë“±ë¡ëœ í”„ë¡œê·¸ë¨ì´ ì—†ê±°ë‚˜ í•™ë²ˆì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>';
        return;
      }
      
      let html = '';
      let totalApplicants = 0;
      
      programs.forEach(program => {
        totalApplicants += program.count;
        
        const maxCount = program.maxCount || 7;
        const statusLabel = program.count >= maxCount ? 'ë§ˆê°' : (program.count >= 3 ? 'ê°œì„¤' : 'ë¯¸ê°œì„¤');
        const statusClass = statusLabel === 'ë§ˆê°' ? 'badge-full' : statusLabel === 'ê°œì„¤' ? 'badge-open' : 'badge-warning';
        const statusBadge = `<span class="badge ${statusClass}">${statusLabel}</span>`;
        
        html += `
          <div class="program-card">
            <h3>ğŸ“… ${escapeHtml(program.date)} ${escapeHtml(program.startTime)}-${escapeHtml(program.endTime)}</h3>
            <div class="program-info">
              <strong>ğŸ“ ì¥ì†Œ:</strong> ${escapeHtml(program.location)}
            </div>
            <div class="program-info">
              <strong>ğŸ“ ë‚´ìš©:</strong><br>${escapeHtml(program.content)}
            </div>
            <div class="program-info">
              <strong>ğŸ‘¥ ì‹ ì²­ì ìˆ˜:</strong> ${program.count}/${maxCount}ëª… ${statusBadge}
            </div>
            
            ${program.applicants && program.applicants.length > 0 ? `
              <div style="margin-top: 15px;">
                <h4>ì‹ ì²­ì ëª…ë‹¨</h4>
                <div class="table-wrapper">
                  <table>
                    <thead>
                      <tr>
                        <th>ì´ë¦„</th>
                        <th>í•™ë²ˆ</th>
                        <th>í•™ê³¼</th>
                        <th>ì—°ë½ì²˜</th>
                        <th>ì´ë©”ì¼</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${program.applicants.map(applicant => `
                        <tr>
                          <td>${escapeHtml(applicant.name)}</td>
                          <td>${escapeHtml(applicant.studentId)}</td>
                          <td>${escapeHtml(applicant.department)}</td>
                          <td><a href="tel:${safeTel(applicant.phone)}">${escapeHtml(applicant.phone)}</a></td>
                          <td><a href="mailto:${safeMailto(applicant.email)}">${escapeHtml(applicant.email)}</a></td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
            ` : `
              <div class="alert alert-warning" style="margin-top: 15px;">
                ì•„ì§ ì‹ ì²­ìê°€ ì—†ìŠµë‹ˆë‹¤.
              </div>
            `}
          </div>
        `;
      });
      
      // ìƒë‹¨ì— ì „ì²´ í†µê³„ ì¶”ê°€
      const summaryHtml = `
        <div class="stats-grid">
          <div class="stat-card">
            <h4>ì´ í”„ë¡œê·¸ë¨ ìˆ˜</h4>
            <div class="number">${programs.length}</div>
          </div>
          <div class="stat-card">
            <h4>ì´ ì‹ ì²­ì ìˆ˜</h4>
            <div class="number">${totalApplicants}</div>
          </div>
          <div class="stat-card">
            <h4>í‰ê·  ì‹ ì²­ë¥ </h4>
            <div class="number">${Math.round((totalApplicants / (programs.length * 7)) * 100)}%</div>
          </div>
          <div class="stat-card">
            <h4>ë§ˆê° í”„ë¡œê·¸ë¨</h4>
            <div class="number">${programs.filter(p => p.count >= 7).length}</div>
          </div>
        </div>
      `;
      
      document.getElementById('programs').innerHTML = summaryHtml + html;
    }
    
    // ë‹¤ì‹œ ì¡°íšŒ
    function backToSearch() {
      document.getElementById('loginForm').style.display = 'block';
      document.getElementById('mentorDashboard').style.display = 'none';
      document.getElementById('mentorId').value = '';
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í™•ì¸
    window.onload = function() {
      console.log('ë©˜í†  í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
    };
  </script>
</body>
</html>
